<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Study Planner - King's College London</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f8f9fa;
      min-height: 100vh;
      color: #212529;
    }
    
    .header {
      background: linear-gradient(135deg, #e52d27 0%, #b31217 100%);
      color: white;
      padding: 40px 0;
      box-shadow: 0 4px 20px rgba(229, 45, 39, 0.3);
      position: relative;
    }
    
    .header-content {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .header-content > div:first-child {
      text-align: center;
      flex: 1;
    }
    
    .header-actions {
      display: flex;
      gap: 12px;
      align-items: center;
    }
    
    .theme-toggle, .action-btn {
      background: rgba(255, 255, 255, 0.2);
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 50px;
      padding: 10px 16px;
      color: white;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 6px;
      backdrop-filter: blur(10px);
      font-weight: 500;
    }
    
    .theme-toggle {
      padding: 12px;
      min-width: 44px;
      justify-content: center;
    }
    
    .theme-toggle:hover, .action-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: translateY(-2px);
    }
    
    .theme-icon, .action-icon {
      font-size: 16px;
    }
    .header h1 { font-size: 32px; margin-bottom: 8px; font-weight: 700; }
    .header .subtitle { font-size: 16px; opacity: 0.95; }
    .header .uni-name { margin-top: 12px; font-size: 12px; font-weight: 600; letter-spacing: 2px; opacity: 0.85; }
    
    .main-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 30px 20px;
      display: grid;
      grid-template-columns: 380px 1fr;
      gap: 30px;
      min-height: calc(100vh - 200px);
    }
    
    @media (max-width: 1200px) {
      .main-container {
        grid-template-columns: 1fr;
        gap: 20px;
      }
    }
    
    .left-panel {
      background: white;
      border-radius: 16px;
      padding: 30px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.1);
      border: 1px solid #e9ecef;
      height: fit-content;
      position: sticky;
      top: 30px;
    }
    
    .right-panel {
      background: white;
      border-radius: 16px;
      padding: 30px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.1);
      border: 1px solid #e9ecef;
      min-height: 600px;
    }
    
    .panel-title {
      font-size: 24px;
      font-weight: 700;
      color: #212529;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .intro-text {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 25px;
      border-left: 4px solid #e52d27;
      color: #495057;
      line-height: 1.6;
      font-size: 14px;
    }
    
    .input-group { 
      margin-bottom: 25px;
    }
    
    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #212529;
      font-size: 14px;
    }
    
    select, input[type="number"] {
      width: 100%;
      padding: 14px 16px;
      border: 2px solid #dee2e6;
      border-radius: 10px;
      font-size: 15px;
      transition: all 0.3s ease;
      background: white;
      font-weight: 500;
    }
    
    select:focus, input[type="number"]:focus {
      outline: none;
      border-color: #e52d27;
      box-shadow: 0 0 0 4px rgba(229, 45, 39, 0.1);
    }
    
    .helper-text { 
      font-size: 12px; 
      color: #6c757d; 
      margin-top: 6px; 
      line-height: 1.4;
    }
    
    .calculate-btn {
      width: 100%;
      padding: 16px;
      background: linear-gradient(135deg, #e52d27 0%, #b31217 100%);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-top: 20px;
      box-shadow: 0 6px 20px rgba(229, 45, 39, 0.25);
    }
    
    .calculate-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(229, 45, 39, 0.35);
    }
    
    .schedule-info {
      background: linear-gradient(135deg, #e8f4f8 0%, #d4e9f2 100%);
      padding: 16px;
      border-radius: 10px;
      margin-top: 15px;
      border-left: 3px solid #17a2b8;
      font-size: 13px;
      color: #0c5460;
      font-weight: 500;
      display: none;
    }
    
    .schedule-info.show { display: block; }
    
    .calendar-container {
      display: none;
    }
    
    .calendar-container.show { display: block; }
    
    .calendar-header {
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 20px;
      text-align: center;
    }
    
    .calendar-controls {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 15px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    
    .activity-select-group {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .activity-select-group label {
      font-weight: 600;
      color: #212529;
      margin: 0;
      white-space: nowrap;
    }
    
    .control-buttons {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    .btn {
      padding: 10px 16px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      border: none;
      text-align: center;
      white-space: nowrap;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #e52d27 0%, #b31217 100%);
      color: white;
      box-shadow: 0 4px 12px rgba(229,45,39,0.25);
    }
    
    .btn-secondary {
      background: white;
      color: #e52d27;
      border: 2px solid #e52d27;
    }
    
    .btn-secondary:hover { 
      background: #e52d27; 
      color: white; 
    }
    
    .legend {
      display: flex;
      justify-content: center;
      gap: 15px;
      flex-wrap: wrap;
      margin-bottom: 15px;
    }
    
    .legend-item {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
      color: #495057;
    }
    
    .legend-color {
      width: 14px;
      height: 14px;
      border-radius: 3px;
    }
    
    .calendar-grid {
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      border: 1px solid #e9ecef;
    }
    
    .weekly-grid {
      display: grid;
      grid-template-columns: 60px repeat(7, 1fr);
      grid-auto-rows: 22px;
      user-select: none;
    }
    
    .grid-header {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      font-size: 11px;
      text-align: center;
      line-height: 22px;
      font-weight: 600;
      color: #495057;
    }
    
    .grid-cell {
      border: 1px solid #f1f1f1;
      text-align: center;
      cursor: pointer;
      transition: all 0.15s ease;
      font-size: 10px;
      line-height: 22px;
    }
    
    .grid-cell:hover:not(.work):not(.sleep) { 
      background: rgba(229, 45, 39, 0.1);
    }
    
    .grid-cell.study { background: #28a745; color: white; }
    .grid-cell.work { background: #e52d27; color: white; }
    .grid-cell.sleep { background: #6c757d; color: white; }
    .grid-cell.family { background: #ff6b6b; color: white; }
    .grid-cell.social { background: #ffc107; color: #212529; font-weight:600; }
    .grid-cell.other { background: #96ceb4; color: white; }
    
    .stats-section {
      margin-top: 25px;
      display: none;
    }
    
    .stats-section.show { display: block; }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
      gap: 12px;
      margin-bottom: 20px;
    }
    
    .stat-item {
      text-align: center;
      padding: 12px 8px;
      background: #f8f9fa;
      border-radius: 8px;
      border: 1px solid #e9ecef;
    }
    
    .stat-value {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 4px;
    }
    
    .stat-label {
      font-size: 11px;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .chart-container {
      max-width: 300px;
      margin: 0 auto;
      height: 200px;
    }
    
    .usage-tip {
      background: #fff3cd;
      border: 1px solid #ffeaa7;
      padding: 12px;
      border-radius: 8px;
      font-size: 13px;
      color: #856404;
      margin-bottom: 15px;
      text-align: center;
    }
    
    /* Dark mode styles */
    [data-theme="dark"] {
      --bg-primary: #1a1a1a;
      --bg-secondary: #2d2d2d;
      --bg-tertiary: #3a3a3a;
      --text-primary: #ffffff;
      --text-secondary: #b3b3b3;
      --text-muted: #888888;
      --border-color: #404040;
      --hover-bg: #404040;
      --card-bg: #2d2d2d;
      --input-bg: #3a3a3a;
    }
    
    [data-theme="light"] {
      --bg-primary: #f8f9fa;
      --bg-secondary: #ffffff;
      --bg-tertiary: #f8f9fa;
      --text-primary: #212529;
      --text-secondary: #495057;
      --text-muted: #6c757d;
      --border-color: #e9ecef;
      --hover-bg: #f8f9fa;
      --card-bg: #ffffff;
      --input-bg: #ffffff;
    }
    
    body {
      background: var(--bg-primary);
      color: var(--text-primary);
      transition: background-color 0.3s ease, color 0.3s ease;
    }
    
    .left-panel, .right-panel {
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      color: var(--text-primary);
    }
    
    .intro-text {
      background: var(--bg-tertiary);
      color: var(--text-secondary);
    }
    
    .panel-title {
      color: var(--text-primary);
    }
    
    label {
      color: var(--text-primary);
    }
    
    select, input[type="number"] {
      background: var(--input-bg);
      border: 2px solid var(--border-color);
      color: var(--text-primary);
    }
    
    select:focus, input[type="number"]:focus {
      border-color: #e52d27;
    }
    
    .helper-text {
      color: var(--text-muted);
    }
    
    .calendar-header {
      background: var(--bg-tertiary);
    }
    
    .grid-header {
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      color: var(--text-secondary);
    }
    
    .grid-cell {
      border: 1px solid var(--border-color);
    }
    
    .grid-cell:hover:not(.work):not(.sleep) { 
      background: rgba(229, 45, 39, 0.1);
    }
    
    .stat-item {
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
    }
    
    .stat-label {
      color: var(--text-muted);
    }
    
    .calendar-grid {
      background: var(--card-bg);
      border: 1px solid var(--border-color);
    }
    
    .usage-tip {
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      color: var(--text-secondary);
    }
    
    [data-theme="dark"] .usage-tip {
      background: #2a2a1a;
      border: 1px solid #4a4a2a;
      color: #d4d4aa;
    }
    
    .schedule-info {
      background: var(--bg-tertiary);
      color: var(--text-secondary);
    }
    
    [data-theme="dark"] .schedule-info {
      background: #1a2a2a;
      border-left: 3px solid #17a2b8;
      color: #a2d2df;
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="header-content">
      <div>
        <h1>Study Planner</h1>
        <div class="subtitle">Realistic recommendations for your schedule</div>
        <div class="uni-name">KING'S COLLEGE LONDON</div>
      </div>
      <div class="header-actions">
        <button id="printBtn" class="action-btn" aria-label="Print schedule">
          <span>Print</span>
        </button>
        <button id="downloadBtn" class="action-btn" aria-label="Download schedule">
          <span>Download</span>
        </button>
        <button id="themeToggle" class="theme-toggle" aria-label="Toggle dark mode">
          <span class="theme-icon">◐</span>
        </button>
      </div>
    </div>
  </div>

  <div class="main-container">
    <!-- Left Panel: Form Controls -->
    <div class="left-panel">
      <div class="panel-title">
        Your Commitments
      </div>
      
      <div class="intro-text">
        Plan your study time around your existing work and sleep schedule for realistic academic goals.
      </div>
      
      <form id="calculatorForm">
        <div class="input-group">
          <label>Work & Commute Schedule</label>
          <select id="workSchedule" required>
            <option value="">Select your work schedule</option>
            <option value="custom" data-hours="15">Custom hours per week</option>
            <option value="part-time-20" data-hours="20">Part-time: 9am-1pm (20 hrs/week)</option>
            <option value="part-time-25" data-hours="25">Part-time: 9am-2pm (25 hrs/week)</option>
            <option value="part-time-30" data-hours="30">Part-time: 9am-3pm (30 hrs/week)</option>
            <option value="standard" data-hours="40" selected>Standard: 9am-5pm (40 hrs/week)</option>
            <option value="extended-45" data-hours="45">Extended: 8am-5pm (45 hrs/week)</option>
            <option value="extended-50" data-hours="50">Extended: 7am-5pm or 8am-6pm (50 hrs/week)</option>
            <option value="long-55" data-hours="55">Long hours: 7am-6pm (55 hrs/week)</option>
            <option value="long-60" data-hours="60">Long hours: 7am-7pm (60 hrs/week)</option>
          </select>
          <div class="helper-text">Includes commute time, automatically scheduled Mon-Fri</div>
        </div>

        <div class="input-group">
          <label>Sleep Schedule</label>
          <select id="sleepSchedule" required>
            <option value="">Select your sleep pattern</option>
            <option value="custom" data-hours="30">Custom hours per week</option>
            <option value="short" data-hours="35">Short: 11:30pm-6:30am (35 hrs/week)</option>
            <option value="light" data-hours="42">Light: 11pm-6am (42 hrs/week)</option>
            <option value="average" data-hours="49" selected>Average: 10:30pm-6am (49 hrs/week)</option>
            <option value="good" data-hours="56">Good: 10pm-6am (56 hrs/week)</option>
            <option value="extended" data-hours="63">Extended: 9:30pm-6am (63 hrs/week)</option>
          </select>
          <div class="helper-text">Automatically scheduled every night</div>
        </div>

        <button type="submit" class="calculate-btn">Generate Study Plan</button>
      </form>

      <div id="scheduleInfo" class="schedule-info">
        <div style="font-weight: 600; margin-bottom: 8px;">Schedule Overview</div>
        <div id="scheduleBreakdown"></div>
      </div>

      <!-- Stats Section -->
      <div id="statsSection" class="stats-section">
        <div style="font-size: 18px; font-weight: 600; margin-bottom: 15px; text-align: center;">Weekly Breakdown</div>
        <div id="statsGrid" class="stats-grid"></div>
        <div class="chart-container">
          <canvas id="scheduleChart" width="300" height="200"></canvas>
        </div>
      </div>
    </div>

    <!-- Right Panel: Calendar -->
    <div class="right-panel">
      <div class="panel-title">
        Interactive Schedule Builder
      </div>
      
      <div id="calendarContainer" class="calendar-container">
        <div class="calendar-header">
          <p style="color:#495057; margin-bottom:15px; font-weight:500;">
            <strong>Work & Sleep</strong> are pre-filled. Schedule your remaining activities below.
          </p>
          
          <div class="legend">
            <div class="legend-item">
              <div class="legend-color" style="background:#e52d27;"></div>
              <span>Work (Auto)</span>
            </div>
            <div class="legend-item">
              <div class="legend-color" style="background:#6c757d;"></div>
              <span>Sleep (Auto)</span>
            </div>
            <div class="legend-item">
              <div class="legend-color" style="background:#28a745;"></div>
              <span>Study</span>
            </div>
            <div class="legend-item">
              <div class="legend-color" style="background:#ff6b6b;"></div>
              <span>Family</span>
            </div>
            <div class="legend-item">
              <div class="legend-color" style="background:#ffc107;"></div>
              <span>Social</span>
            </div>
            <div class="legend-item">
              <div class="legend-color" style="background:#96ceb4;"></div>
              <span>Other</span>
            </div>
          </div>
        </div>
        
        <div class="calendar-controls">
          <div class="activity-select-group">
            <label>Paint with:</label>
            <select id="activitySelect" style="padding:8px 12px; border-radius:8px; border:2px solid #dee2e6; font-size:14px; background:white;">
              <option value="study" selected>Study Sessions</option>
              <option value="family">Family Time</option>
              <option value="social">Social & Fun</option>
              <option value="other">Other Commitments</option>
            </select>
          </div>
          
          <div class="control-buttons">
            <button id="clearPersonal" class="btn btn-secondary">Clear Personal</button>
            <button id="smartSuggest" class="btn btn-primary">Smart Fill</button>
          </div>
        </div>
        
        <div class="usage-tip">
          <strong>Tip:</strong> Click and drag to fill time slots. Right-click to remove activities.
        </div>
        
        <div class="calendar-grid">
          <div id="weeklyGrid" class="weekly-grid"></div>
        </div>
      </div>

      <!-- Placeholder when no schedule generated -->
      <div id="calendarPlaceholder" style="text-align: center; padding: 80px 20px; color: #6c757d;">
        <div style="font-size: 48px; margin-bottom: 20px;">📅</div>
        <h3 style="margin-bottom: 12px; color: #495057;">Your Schedule Will Appear Here</h3>
        <p>Select your work and sleep schedules on the left to get started.</p>
      </div>
    </div>
  </div>

  <script>
    // Form submission
    document.getElementById('calculatorForm').addEventListener('submit', function(e) {
      e.preventDefault();
      
      const workSchedule = document.getElementById('workSchedule');
      const sleepSchedule = document.getElementById('sleepSchedule');
      
      if (!workSchedule.value || !sleepSchedule.value) {
        alert('Please select both work and sleep schedules');
        return;
      }
      
      const work = parseInt(workSchedule.selectedOptions[0].dataset.hours);
      const sleep = parseInt(sleepSchedule.selectedOptions[0].dataset.hours);
      
      const totalCommitted = work + sleep;
      let available = 168 - totalCommitted;
      if (available < 0) available = 0;
      
      // Show schedule info
      const scheduleInfo = document.getElementById('scheduleInfo');
      const breakdown = document.getElementById('scheduleBreakdown');
      breakdown.innerHTML = `
        <div>Work: <strong>${work} hours/week</strong></div>
        <div>Sleep: <strong>${sleep} hours/week</strong></div>
        <div style="color: #28a745; font-weight: 600;">Available: <strong>${available} hours/week</strong></div>
      `;
      scheduleInfo.classList.add('show');
      
      // Initialize and populate calendar
      populateSchedule(workSchedule.value, sleepSchedule.value);
      
      // Show calendar
      document.getElementById('calendarPlaceholder').style.display = 'none';
      document.getElementById('calendarContainer').classList.add('show');
      
      // Add event listeners
      setTimeout(() => {
        addPlannerEventListeners();
      }, 100);
    });

    let scheduleChart;
    let isDragging = false;
    let currentActivity = 'study';

    // Initialize grid
    function initWeeklyGrid() {
      const grid = document.getElementById('weeklyGrid');
      const days = ['Time', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
      grid.innerHTML = '';
      
      days.forEach(d => {
        const div = document.createElement('div');
        div.className = 'grid-header';
        div.textContent = d;
        grid.appendChild(div);
      });
      
      for(let hour = 0; hour < 24; hour++) {
        const label = document.createElement('div');
        label.className = 'grid-header';
        label.textContent = `${hour}:00`;
        grid.appendChild(label);
        
        for(let day = 0; day < 7; day++) {
          const cell = document.createElement('div');
          cell.className = 'grid-cell';
          cell.dataset.day = day;
          cell.dataset.hour = hour;
          cell.addEventListener('mousedown', handleCellClick);
          cell.addEventListener('mouseover', handleCellDrag);
          grid.appendChild(cell);
        }
      }
    }

    // Mouse event handlers
    document.addEventListener('mousedown', () => isDragging = true);
    document.addEventListener('mouseup', () => isDragging = false);
    
    function handleCellClick(e) {
      const cell = e.target;
      if(e.button === 2) {
        cell.className = 'grid-cell';
        updateStats();
        return;
      }
      
      if(cell.classList.contains('work') || cell.classList.contains('sleep')) {
        return;
      }
      
      const activity = currentActivity;
      const wasSelected = cell.classList.contains(activity);
      cell.className = 'grid-cell';
      if(!wasSelected) cell.classList.add(activity);
      updateStats();
    }
    
    function handleCellDrag(e) {
      if(!isDragging) return;
      const cell = e.target;
      if(!cell.classList.contains('grid-cell')) return;
      
      if(cell.classList.contains('work') || cell.classList.contains('sleep')) {
        return;
      }
      
      cell.className = 'grid-cell ' + currentActivity;
      updateStats();
    }
    
    // Prevent context menu
    document.addEventListener('contextmenu', e => {
      if(e.target.classList.contains('grid-cell')) {
        e.preventDefault();
      }
    });

    // Add event listeners
    function addPlannerEventListeners() {
      const activitySelect = document.getElementById('activitySelect');
      const clearPersonal = document.getElementById('clearPersonal');
      const smartSuggest = document.getElementById('smartSuggest');
      
      if(activitySelect) {
        activitySelect.addEventListener('change', e => {
          currentActivity = e.target.value;
        });
      }
      
      if(clearPersonal) {
        clearPersonal.addEventListener('click', () => {
          document.querySelectorAll('.grid-cell').forEach(c => {
            if(!c.classList.contains('work') && !c.classList.contains('sleep')) {
              c.className = 'grid-cell';
            }
          });
          updateStats();
        });
      }
      
      if(smartSuggest) {
        smartSuggest.addEventListener('click', () => {
          smartSuggestSchedule();
        });
      }
    }
    
    // Populate schedule
    function populateSchedule(workType, sleepType) {
      document.querySelectorAll('.grid-cell').forEach(c => c.className = 'grid-cell');
      
      // Schedule work Monday-Friday
      const workHours = getWorkHours(workType);
      for(let day = 0; day < 5; day++) {
        for(let hour = workHours.start; hour < workHours.end; hour++) {
          const cell = document.querySelector(`[data-day="${day}"][data-hour="${hour}"]`);
          if(cell) cell.classList.add('work');
        }
      }
      
      // Schedule sleep every night
      const sleepHours = getSleepHours(sleepType);
      for(let day = 0; day < 7; day++) {
        let startHour = sleepHours.start;
        let endHour = sleepHours.end;
        
        if(startHour % 1 !== 0) {
          startHour = Math.floor(startHour);
        }
        if(endHour % 1 !== 0) {
          endHour = Math.ceil(endHour);
        }
        
        if(startHour >= 21) {
          for(let hour = startHour; hour < 24; hour++) {
            const cell = document.querySelector(`[data-day="${day}"][data-hour="${hour}"]`);
            if(cell) cell.classList.add('sleep');
          }
        }
        
        for(let hour = 0; hour < endHour; hour++) {
          const cell = document.querySelector(`[data-day="${day}"][data-hour="${hour}"]`);
          if(cell) cell.classList.add('sleep');
        }
      }
      
      updateStats();
    }
    
    function getWorkHours(workType) {
      const schedules = {
        'custom': {start: 9, end: 12},
        'part-time-20': {start: 9, end: 13},
        'part-time-25': {start: 9, end: 14},
        'part-time-30': {start: 9, end: 15},
        'standard': {start: 9, end: 17},
        'extended-45': {start: 8, end: 17},
        'extended-50': {start: 7, end: 17},
        'long-55': {start: 7, end: 18},
        'long-60': {start: 7, end: 19}
      };
      return schedules[workType] || schedules.standard;
    }
    
    function getSleepHours(sleepType) {
      const schedules = {
        'custom': {start: 23, end: 6},
        'short': {start: 23.5, end: 6.5},
        'light': {start: 23, end: 6},
        'average': {start: 22.5, end: 6},
        'good': {start: 22, end: 6},
        'extended': {start: 21.5, end: 6}
      };
      return schedules[sleepType] || schedules.average;
    }

    function updateStats() {
      const cells = document.querySelectorAll('.grid-cell');
      const countBy = {study:0, work:0, sleep:0, family:0, social:0, other:0};
      
      cells.forEach(c => {
        if(c.classList.length > 1) {
          const act = c.classList[1];
          if(countBy[act] !== undefined) countBy[act]++;
        }
      });
      
      updateStatsDisplay(countBy);
      createScheduleChart(countBy);
    }
    
    function updateStatsDisplay(counts) {
      const statsSection = document.getElementById('statsSection');
      const statsGrid = document.getElementById('statsGrid');
      
      const total = counts.work + counts.sleep + counts.study + counts.family + counts.social + counts.other;
      const available = 168 - total;
      
      statsGrid.innerHTML = `
        <div class="stat-item">
          <div class="stat-value" style="color:#e52d27;">${counts.work}h</div>
          <div class="stat-label">Work</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" style="color:#6c757d;">${counts.sleep}h</div>
          <div class="stat-label">Sleep</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" style="color:#28a745;">${counts.study}h</div>
          <div class="stat-label">Study</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" style="color:#ff6b6b;">${counts.family}h</div>
          <div class="stat-label">Family</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" style="color:#ffc107;">${counts.social}h</div>
          <div class="stat-label">Social</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" style="color:#96ceb4;">${counts.other}h</div>
          <div class="stat-label">Other</div>
        </div>
        ${available > 0 ? `<div class="stat-item" style="border: 2px solid #28a745;">
          <div class="stat-value" style="color:#28a745;">${available}h</div>
          <div class="stat-label">Free</div>
        </div>` : ''}
      `;
      
      if(total > counts.work + counts.sleep) {
        statsSection.classList.add('show');
      }
    }
    
    function createScheduleChart(counts) {
      const canvas = document.getElementById('scheduleChart');
      if (!canvas) return;
      
      const ctx = canvas.getContext('2d');
      if(scheduleChart) scheduleChart.destroy();
      
      const data = [counts.work, counts.sleep, counts.study, counts.family, counts.social, counts.other];
      const labels = ['Work', 'Sleep', 'Study', 'Family', 'Social', 'Other'];
      const colors = ['#e52d27', '#6c757d', '#28a745', '#ff6b6b', '#ffc107', '#96ceb4'];
      
      scheduleChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: labels,
          datasets: [{
            data: data,
            backgroundColor: colors,
            borderWidth: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            }
          }
        }
      });
    }
    
    function smartSuggestSchedule() {
      // Clear personal commitments first
      document.querySelectorAll('.grid-cell').forEach(c => {
        if(!c.classList.contains('work') && !c.classList.contains('sleep')) {
          c.className = 'grid-cell';
        }
      });
      
      // Smart suggestions for balanced schedule
      const suggestions = [
        // Study sessions - prioritized times
        {activity: 'study', days: [0,1,2,3,4], hours: [7,8], weight: 0.8}, // Early morning
        {activity: 'study', days: [0,1,2,3,4], hours: [18,19,20], weight: 0.9}, // Evening
        {activity: 'study', days: [5,6], hours: [9,10,11,14,15,16], weight: 0.8}, // Weekend blocks
        {activity: 'study', days: [6], hours: [19,20], weight: 0.6}, // Sunday prep
        
        // Family time
        {activity: 'family', days: [0,1,2,3,4], hours: [17], weight: 0.7}, // Weekday dinner
        {activity: 'family', days: [6], hours: [12,13], weight: 0.8}, // Sunday lunch
        {activity: 'family', days: [5], hours: [18], weight: 0.5}, // Friday evening
        
        // Social & Leisure
        {activity: 'social', days: [5], hours: [20,21], weight: 0.7}, // Friday night
        {activity: 'social', days: [6], hours: [17,18], weight: 0.6}, // Saturday evening
        {activity: 'social', days: [1,3], hours: [21], weight: 0.3}, // Weeknight social
        {activity: 'social', days: [0], hours: [15,16], weight: 0.4}, // Sunday afternoon
        
        // Other commitments
        {activity: 'other', days: [6], hours: [8,9], weight: 0.8}, // Saturday errands
        {activity: 'other', days: [2], hours: [19], weight: 0.4}, // Mid-week tasks
        {activity: 'other', days: [5], hours: [17], weight: 0.5}, // Friday admin
      ];
      
      suggestions.forEach(suggestion => {
        suggestion.days.forEach(day => {
          suggestion.hours.forEach(hour => {
            if(Math.random() < suggestion.weight) {
              const cell = document.querySelector(`[data-day="${day}"][data-hour="${hour}"]`);
              if(cell && !cell.classList.contains('work') && !cell.classList.contains('sleep') && cell.className === 'grid-cell') {
                cell.classList.add(suggestion.activity);
              }
            }
          });
        });
      });
      
      updateStats();
      
      setTimeout(() => {
        alert('Smart schedule applied! This suggests ~22h study, balanced with family and social time. Adjust as needed for your preferences.');
      }, 300);
    }
    
    // Theme toggle functionality
    function initTheme() {
      const savedTheme = localStorage.getItem('theme') || 'light';
      document.documentElement.setAttribute('data-theme', savedTheme);
      updateThemeToggle(savedTheme);
    }
    
    function toggleTheme() {
      const currentTheme = document.documentElement.getAttribute('data-theme');
      const newTheme = currentTheme === 'light' ? 'dark' : 'light';
      
      document.documentElement.setAttribute('data-theme', newTheme);
      localStorage.setItem('theme', newTheme);
      updateThemeToggle(newTheme);
    }
    
    function updateThemeToggle(theme) {
      const toggle = document.getElementById('themeToggle');
      const icon = toggle.querySelector('.theme-icon');
      
      if (theme === 'dark') {
        icon.textContent = '◑';
        toggle.setAttribute('aria-label', 'Switch to light mode');
      } else {
        icon.textContent = '◐';
        toggle.setAttribute('aria-label', 'Switch to dark mode');
      }
    }
    
    // Print functionality
    function printSchedule() {
      const printContent = `
        <html>
          <head>
            <title>Study Schedule - King's College London</title>
            <style>
              body { font-family: Arial, sans-serif; margin: 20px; }
              .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #e52d27; padding-bottom: 20px; }
              .schedule-grid { display: grid; grid-template-columns: 60px repeat(7, 1fr); grid-auto-rows: 25px; border: 1px solid #ccc; }
              .grid-header { background: #f5f5f5; border: 1px solid #ccc; text-align: center; font-weight: bold; font-size: 12px; line-height: 25px; }
              .grid-cell { border: 1px solid #ddd; text-align: center; font-size: 10px; line-height: 25px; }
              .study { background: #28a745; color: white; }
              .work { background: #e52d27; color: white; }
              .sleep { background: #6c757d; color: white; }
              .family { background: #ff6b6b; color: white; }
              .social { background: #ffc107; color: #212529; }
              .other { background: #96ceb4; color: white; }
              .stats { margin-top: 20px; display: flex; gap: 20px; justify-content: center; }
              .stat-item { text-align: center; padding: 10px; border: 1px solid #ddd; border-radius: 5px; }
              @media print { body { margin: 0; } }
            </style>
          </head>
          <body>
            <div class="header">
              <h1>Study Schedule</h1>
              <p>King's College London</p>
              <p>Generated on: ${new Date().toLocaleDateString()}</p>
            </div>
            ${generatePrintableGrid()}
            ${generatePrintableStats()}
          </body>
        </html>
      `;
      
      const printWindow = window.open('', '_blank');
      printWindow.document.write(printContent);
      printWindow.document.close();
      printWindow.print();
    }
    
    // Download functionality
    function downloadSchedule() {
      const scheduleData = generateScheduleData();
      const csvContent = generateCSV(scheduleData);
      
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      
      link.setAttribute('href', url);
      link.setAttribute('download', `study-schedule-${new Date().toISOString().split('T')[0]}.csv`);
      link.style.visibility = 'hidden';
      
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }
    
    function generatePrintableGrid() {
      const grid = document.getElementById('weeklyGrid');
      if (!grid) return '<p>No schedule generated yet.</p>';
      
      const days = ['Time', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
      let html = '<div class="schedule-grid">';
      
      // Headers
      days.forEach(day => {
        html += `<div class="grid-header">${day}</div>`;
      });
      
      // Time slots
      for(let hour = 0; hour < 24; hour++) {
        html += `<div class="grid-header">${hour}:00</div>`;
        for(let day = 0; day < 7; day++) {
          const cell = document.querySelector(`[data-day="${day}"][data-hour="${hour}"]`);
          const classes = cell ? cell.className : 'grid-cell';
          const activity = classes.includes('study') ? 'Study' :
                          classes.includes('work') ? 'Work' :
                          classes.includes('sleep') ? 'Sleep' :
                          classes.includes('family') ? 'Family' :
                          classes.includes('social') ? 'Social' :
                          classes.includes('other') ? 'Other' : '';
          html += `<div class="${classes}">${activity}</div>`;
        }
      }
      
      html += '</div>';
      return html;
    }
    
    function generatePrintableStats() {
      const cells = document.querySelectorAll('.grid-cell');
      const countBy = {study:0, work:0, sleep:0, family:0, social:0, other:0};
      
      cells.forEach(c => {
        if(c.classList.length > 1) {
          const act = c.classList[1];
          if(countBy[act] !== undefined) countBy[act]++;
        }
      });
      
      return `
        <div class="stats">
          <div class="stat-item"><strong>${countBy.work}h</strong><br>Work</div>
          <div class="stat-item"><strong>${countBy.sleep}h</strong><br>Sleep</div>
          <div class="stat-item"><strong>${countBy.study}h</strong><br>Study</div>
          <div class="stat-item"><strong>${countBy.family}h</strong><br>Family</div>
          <div class="stat-item"><strong>${countBy.social}h</strong><br>Social</div>
          <div class="stat-item"><strong>${countBy.other}h</strong><br>Other</div>
        </div>
      `;
    }
    
    function generateScheduleData() {
      const schedule = [];
      const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
      
      for(let hour = 0; hour < 24; hour++) {
        const timeSlot = `${hour}:00`;
        const row = { Time: timeSlot };
        
        for(let day = 0; day < 7; day++) {
          const cell = document.querySelector(`[data-day="${day}"][data-hour="${hour}"]`);
          const activity = cell && cell.classList.length > 1 ? 
            cell.classList[1].charAt(0).toUpperCase() + cell.classList[1].slice(1) : '';
          row[days[day]] = activity;
        }
        
        schedule.push(row);
      }
      
      return schedule;
    }
    
    function generateCSV(data) {
      if (!data.length) return '';
      
      const headers = Object.keys(data[0]);
      const csvRows = [
        headers.join(','),
        ...data.map(row => headers.map(header => row[header] || '').join(','))
      ];
      
      return csvRows.join('\n');
    }
    
    // Initialize on page load
    document.addEventListener('DOMContentLoaded', () => {
      initWeeklyGrid();
      initTheme();
      
      // Add event listeners
      document.getElementById('themeToggle').addEventListener('click', toggleTheme);
      document.getElementById('printBtn').addEventListener('click', printSchedule);
      document.getElementById('downloadBtn').addEventListener('click', downloadSchedule);
    });
  </script>
</body>
</html>
